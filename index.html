<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ 3 —Å–µ–º–µ—Å—Ç—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--tg-theme-bg-color, #f5f7fa);
            color: var(--tg-theme-text-color, #333);
            padding: 20px;
            margin: 0;
            padding-bottom: 140px; /* –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø –¥–ª—è FAB –∫–Ω–æ–ø–æ–∫ */
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--tg-theme-secondary-bg-color, white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--tg-theme-section-bg-color, #f8f9fa);
            border-radius: 8px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3498db);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        h1 {
            text-align: center;
            color: var(--tg-theme-text-color, #2c3e50);
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--tg-theme-section-bg-color, #f8f9fa);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 0.85em;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .free { background: #27ae60; }
        .busy { background: #e74c3c; }
        .weekend { background: #95a5a6; }
        .holiday { background: #00ff00; }
        .online-only { background: #ff8c00; }
        
        .months-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .month {
            border: 2px solid var(--tg-theme-section-separator-color, #ecf0f1);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .month-header {
            background: var(--tg-theme-button-color, #3498db);
            color: var(--tg-theme-button-text-color, white);
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        
        .day-header {
            background: var(--tg-theme-section-bg-color, #34495e);
            color: var(--tg-theme-text-color, white);
            padding: 8px 3px;
            text-align: center;
            font-size: 0.7em;
            font-weight: 600;
        }
        
        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--tg-theme-section-separator-color, #ecf0f1);
            font-weight: 600;
            position: relative;
            cursor: default;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }
        
        .day:active {
            transform: scale(0.95);
        }
        
        .day.free { background: #2ecc71; color: white; }
        .day.busy { background: #e74c3c; color: white; cursor: pointer; }
        .day.online-only { background: #ff8c00; color: white; cursor: pointer; }
        .day.weekend { background: #95a5a6; color: white; }
        .day.holiday { background: #00ff00; color: white; font-weight: bold; }
        .day.other-month { background: #ecf0f1; color: #bdc3c7; }
        
        .day.has-note::after {
            content: 'üìù';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6em;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: var(--tg-theme-bg-color, white);
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s ease;
        }
        
        @keyframes modalAppear {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            background: var(--tg-theme-button-color, #3498db);
            color: var(--tg-theme-button-text-color, white);
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .close {
            color: var(--tg-theme-button-text-color, white);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .class-item {
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--tg-theme-button-color, #3498db);
            background: var(--tg-theme-section-bg-color, #f8f9fa);
            border-radius: 0 8px 8px 0;
            position: relative;
        }
        
        .class-item:last-child {
            margin-bottom: 0;
        }
        
        .class-time {
            font-weight: bold;
            color: var(--tg-theme-text-color, #2c3e50);
            font-size: 1em;
            margin-bottom: 5px;
        }
        
        .class-name {
            color: var(--tg-theme-text-color, #34495e);
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .class-teacher {
            color: var(--tg-theme-hint-color, #7f8c8d);
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        
        .class-format {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .format-online { background: #ffeaa7; color: #d63031; }
        .format-offline { background: #d1f2eb; color: #00b894; }
        
        .note-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--tg-theme-section-separator-color, #eee);
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .note-label {
            font-weight: 600;
            color: var(--tg-theme-text-color, #333);
            font-size: 0.9em;
        }
        
        .note-btn {
            background: var(--tg-theme-button-color, #3498db);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
        }
        
        .note-text {
            background: var(--tg-theme-bg-color, white);
            border: 1px solid var(--tg-theme-section-separator-color, #ddd);
            border-radius: 6px;
            padding: 8px;
            font-size: 0.85em;
            color: var(--tg-theme-text-color, #333);
            line-height: 1.4;
            min-height: 60px;
            resize: vertical;
            width: 100%;
        }
        
        .note-display {
            background: var(--tg-theme-section-bg-color, #f9f9f9);
            border-radius: 6px;
            padding: 8px;
            font-size: 0.85em;
            color: var(--tg-theme-text-color, #333);
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .note-char-count {
            font-size: 0.7em;
            color: var(--tg-theme-hint-color, #666);
            text-align: right;
            margin-top: 4px;
        }
        
        .note-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .btn {
            background: var(--tg-theme-button-color, #3498db);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            flex: 1;
        }
        
        .btn-secondary {
            background: var(--tg-theme-section-bg-color, #6c757d);
            color: var(--tg-theme-text-color, white);
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: var(--tg-theme-section-bg-color, #f8f9fa);
            border-radius: 10px;
            border-left: 5px solid var(--tg-theme-button-color, #3498db);
        }
        
        .summary h3 {
            color: var(--tg-theme-text-color, #2c3e50);
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .stat {
            text-align: center;
            padding: 12px;
            background: var(--tg-theme-bg-color, white);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--tg-theme-button-color, #27ae60);
        }
        
        .stat-label {
            color: var(--tg-theme-hint-color, #7f8c8d);
            margin-top: 5px;
            font-size: 0.8em;
        }
        
        .fab-container {
            position: fixed;
            right: 16px;
            bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 999;
        }
        
        .fab {
            padding: 12px 16px;
            border-radius: 999px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,.15);
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab.danger {
            background: var(--tg-theme-destructive-text-color, #d9534f);
        }
        
        #electivesModal { 
            display: none; 
            position: fixed; 
            z-index: 2000; 
            inset: 0; 
            background: rgba(0,0,0,.4); 
        }
        
        #electivesModal .modal-content { 
            background: var(--tg-theme-bg-color, #fff); 
            margin: 5% auto; 
            padding: 16px; 
            border-radius: 12px; 
            width: min(560px, 92%); 
        }
        
        .electives-list { 
            display: grid; 
            gap: 8px; 
            margin: 12px 0; 
        }
        
        .electives-actions { 
            display: flex; 
            gap: 8px; 
            justify-content: flex-end; 
            margin-top: 12px; 
        }
        
        @media (max-width: 768px) {
            body { 
                padding: 10px; 
                padding-bottom: 140px;
            }
            .container { padding: 15px; }
            .months-grid { grid-template-columns: 1fr; gap: 15px; }
            .legend { flex-direction: column; gap: 8px; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            h1 { font-size: 1.5em; }
            .day { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-info" id="userInfo" style="display: none;">
            <div class="user-avatar" id="userAvatar"></div>
            <div>
                <div id="userName"></div>
                <div style="font-size: 0.8em; color: var(--tg-theme-hint-color, #666);" id="userUsername"></div>
            </div>
        </div>
        
        <h1>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π</h1>
        <p style="text-align: center; color: var(--tg-theme-hint-color, #666); margin-bottom: 20px;">3 —Å–µ–º–µ—Å—Ç—Ä ‚Ä¢ –°–µ–Ω—Ç—è–±—Ä—å-–î–µ–∫–∞–±—Ä—å 2025</p>
        
        <div class="legend">
            <div class="legend-item"><div class="legend-color free"></div><span>–°–≤–æ–±–æ–¥–Ω—ã–µ –¥–Ω–∏</span></div>
            <div class="legend-item"><div class="legend-color busy"></div><span>–î–Ω–∏ —Å –∑–∞–Ω—è—Ç–∏—è–º–∏</span></div>
            <div class="legend-item"><div class="legend-color online-only"></div><span>–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span></div>
            <div class="legend-item"><div class="legend-color weekend"></div><span>–í—ã—Ö–æ–¥–Ω—ã–µ</span></div>
            <div class="legend-item"><div class="legend-color holiday"></div><span>–ü—Ä–∞–∑–¥–Ω–∏–∫–∏ –†–§</span></div>
        </div>
        
        <div class="months-grid">
            <!-- –°–µ–Ω—Ç—è–±—Ä—å 2025 -->
            <div class="month">
                <div class="month-header">–°–µ–Ω—Ç—è–±—Ä—å 2025</div>
                <div class="calendar-grid">
                    <div class="day-header">–ü–Ω</div><div class="day-header">–í—Ç</div><div class="day-header">–°—Ä</div><div class="day-header">–ß—Ç</div><div class="day-header">–ü—Ç</div><div class="day-header">–°–±</div><div class="day-header">–í—Å</div>
                    <div class="day free">1</div><div class="day free">2</div><div class="day free">3</div><div class="day free">4</div><div class="day free">5</div><div class="day weekend">6</div><div class="day weekend">7</div>
                    <div class="day free">8</div><div class="day free">9</div><div class="day busy" data-date="2025-09-10">10</div><div class="day free">11</div><div class="day busy" data-date="2025-09-12">12</div><div class="day busy" data-date="2025-09-13">13</div><div class="day weekend">14</div>
                    <div class="day online-only" data-date="2025-09-15">15</div><div class="day free">16</div><div class="day busy" data-date="2025-09-17">17</div><div class="day free">18</div><div class="day free">19</div><div class="day busy" data-date="2025-09-20">20</div><div class="day weekend">21</div>
                    <div class="day busy" data-date="2025-09-22">22</div><div class="day free">23</div><div class="day busy" data-date="2025-09-24">24</div><div class="day busy" data-date="2025-09-25">25</div><div class="day busy" data-date="2025-09-26">26</div><div class="day busy" data-date="2025-09-27">27</div><div class="day weekend">28</div>
                    <div class="day free">29</div><div class="day free">30</div>
                </div>
            </div>
            <!-- –û–∫—Ç—è–±—Ä—å 2025 -->
            <div class="month">
                <div class="month-header">–û–∫—Ç—è–±—Ä—å 2025</div>
                <div class="calendar-grid">
                    <div class="day-header">–ü–Ω</div><div class="day-header">–í—Ç</div><div class="day-header">–°—Ä</div><div class="day-header">–ß—Ç</div><div class="day-header">–ü—Ç</div><div class="day-header">–°–±</div><div class="day-header">–í—Å</div>
                    <div class="day other-month">29</div><div class="day other-month">30</div><div class="day busy" data-date="2025-10-01">1</div><div class="day online-only" data-date="2025-10-02">2</div><div class="day free">3</div><div class="day busy" data-date="2025-10-04">4</div><div class="day weekend">5</div>
                    <div class="day free">6</div><div class="day free">7</div><div class="day busy" data-date="2025-10-08">8</div><div class="day busy" data-date="2025-10-09">9</div><div class="day busy" data-date="2025-10-10">10</div><div class="day busy" data-date="2025-10-11">11</div><div class="day weekend">12</div>
                    <div class="day busy" data-date="2025-10-13">13</div><div class="day free">14</div><div class="day free">15</div><div class="day free">16</div><div class="day free">17</div><div class="day busy" data-date="2025-10-18">18</div><div class="day weekend">19</div>
                    <div class="day free">20</div><div class="day free">21</div><div class="day free">22</div><div class="day free">23</div><div class="day online-only" data-date="2025-10-24">24</div><div class="day busy" data-date="2025-10-25">25</div><div class="day weekend">26</div>
                    <div class="day busy" data-date="2025-10-27">27</div><div class="day free">28</div><div class="day free">29</div><div class="day free">30</div><div class="day busy" data-date="2025-10-31">31</div>
                </div>
            </div>
            <!-- –ù–æ—è–±—Ä—å 2025 -->
            <div class="month">
                <div class="month-header">–ù–æ—è–±—Ä—å 2025</div>
                <div class="calendar-grid">
                    <div class="day-header">–ü–Ω</div><div class="day-header">–í—Ç</div><div class="day-header">–°—Ä</div><div class="day-header">–ß—Ç</div><div class="day-header">–ü—Ç</div><div class="day-header">–°–±</div><div class="day-header">–í—Å</div>
                    <div class="day other-month">27</div><div class="day other-month">28</div><div class="day other-month">29</div><div class="day other-month">30</div><div class="day other-month">31</div><div class="day busy" data-date="2025-11-01">1</div><div class="day weekend">2</div>
                    <div class="day holiday">3</div><div class="day holiday">4</div><div class="day free">5</div><div class="day free">6</div><div class="day busy" data-date="2025-11-07">7</div><div class="day busy" data-date="2025-11-08">8</div><div class="day weekend">9</div>
                    <div class="day free">10</div><div class="day free">11</div><div class="day free">12</div><div class="day free">13</div><div class="day free">14</div><div class="day busy" data-date="2025-11-15">15</div><div class="day weekend">16</div>
                    <div class="day busy" data-date="2025-11-17">17</div><div class="day free">18</div><div class="day free">19</div><div class="day free">20</div><div class="day free">21</div><div class="day busy" data-date="2025-11-22">22</div><div class="day weekend">23</div>
                    <div class="day free">24</div><div class="day online-only" data-date="2025-11-25">25</div><div class="day free">26</div><div class="day free">27</div><div class="day busy" data-date="2025-11-28">28</div><div class="day busy" data-date="2025-11-29">29</div><div class="day weekend">30</div>
                </div>
            </div>
            <!-- –î–µ–∫–∞–±—Ä—å 2025 -->
            <div class="month">
                <div class="month-header">–î–µ–∫–∞–±—Ä—å 2025</div>
                <div class="calendar-grid">
                    <div class="day-header">–ü–Ω</div><div class="day-header">–í—Ç</div><div class="day-header">–°—Ä</div><div class="day-header">–ß—Ç</div><div class="day-header">–ü—Ç</div><div class="day-header">–°–±</div><div class="day-header">–í—Å</div>
                    <div class="day busy" data-date="2025-12-01">1</div><div class="day online-only" data-date="2025-12-02">2</div><div class="day free">3</div><div class="day free">4</div><div class="day free">5</div><div class="day busy" data-date="2025-12-06">6</div><div class="day weekend">7</div>
                    <div class="day free">8</div><div class="day online-only" data-date="2025-12-09">9</div><div class="day free">10</div><div class="day free">11</div><div class="day free">12</div><div class="day busy" data-date="2025-12-13">13</div><div class="day weekend">14</div>
                    <div class="day busy" data-date="2025-12-15">15</div><div class="day online-only" data-date="2025-12-16">16</div><div class="day free">17</div><div class="day busy" data-date="2025-12-18">18</div><div class="day free">19</div><div class="day busy" data-date="2025-12-20">20</div><div class="day weekend">21</div>
                    <div class="day weekend">22</div><div class="day free">23</div><div class="day free">24</div><div class="day free">25</div><div class="day free">26</div><div class="day weekend">27</div><div class="day weekend">28</div>
                    <div class="day weekend">29</div><div class="day weekend">30</div><div class="day holiday">31</div>
                </div>
            </div>
        </div>
        
        <div class="summary">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="stats">
                <div class="stat"><div class="stat-number" id="freeDaysCount">0</div><div class="stat-label">–°–≤–æ–±–æ–¥–Ω—ã—Ö –¥–Ω–µ–π</div></div>
                <div class="stat"><div class="stat-number" id="classDaysCount">0</div><div class="stat-label">–î–Ω–µ–π —Å –∑–∞–Ω—è—Ç–∏—è–º–∏</div></div>
                <div class="stat"><div class="stat-number">40</div><div class="stat-label">–í—ã—Ö–æ–¥–Ω—ã—Ö</div></div>
                <div class="stat"><div class="stat-number" id="notesCount">0</div><div class="stat-label">–ó–∞–º–µ—Ç–æ–∫</div></div>
            </div>
        </div>
    </div>
    
    <div id="classModal" class="modal"><div class="modal-content"><div class="modal-header"><span class="modal-title" id="modalTitle">–ó–∞–Ω—è—Ç–∏—è</span><span class="close">&times;</span></div><div class="modal-body" id="modalBody"></div></div></div>
    <div id="electivesModal" class="modal"><div class="modal-content"><span class="close" id="closeElectives" style="float:right;font-size:28px;cursor:pointer">&times;</span><h2 style="margin:0 0 8px 0;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–∏ —ç–ª–µ–∫—Ç–∏–≤—ã</h2><div class="electives-list" id="electivesList"></div><div class="electives-actions"><button class="btn btn-secondary" id="cancelElectives">–û—Ç–º–µ–Ω–∞</button><button class="btn" id="saveElectives">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div></div>
    <div class="fab-container"><button id="resetProfile" class="fab danger">–°–±—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è</button><button id="configureElectives" class="fab">–≠–ª–µ–∫—Ç–∏–≤—ã</button></div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const tg = window.Telegram?.WebApp || null;
        let currentUser = null;
        let notesManager = null;
        let selectedElectives = new Set();
        let cs = null; // CloudStorage –∏–ª–∏ LocalStorage

        // --- –î–ê–ù–ù–´–ï –ò –ö–û–ù–°–¢–ê–ù–¢–´ ---
        const classData = {
            '2025-09-10': [{ id: '2025-09-10-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ—á–Ω–æ' }],
            '2025-09-12': [{ id: '2025-09-12-1', time: '18:00 ‚Äì 21:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ—á–Ω–æ' }],
            '2025-09-13': [{ id: '2025-09-13-1', time: '10:00 ‚Äì 13:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ—á–Ω–æ' }],
            '2025-09-15': [{ id: '2025-09-15-1', time: '18:00 ‚Äì 19:30', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ–Ω–ª–∞–π–Ω' }],
            '2025-09-17': [{ id: '2025-09-17-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ—á–Ω–æ' }],
            '2025-09-20': [{ id: '2025-09-20-1', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }],
            '2025-09-22': [{ id: '2025-09-22-1', time: '17:15 ‚Äì 22:00', name: 'Sustainable Finance', teacher: '–ê–Ω–¥—Ä–∏–∞–Ω–æ–≤ –ê.–Æ.', format: '–æ—á–Ω–æ' }],
            '2025-09-24': [{ id: '2025-09-24-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ—á–Ω–æ' }],
            '2025-09-25': [{ id: '2025-09-25-1', time: '18:00 ‚Äì 19:30', name: 'Research Seminar III', teacher: '–°–º–∏—Ä–Ω–æ–≤ –ú.–í.', format: '–æ—á–Ω–æ' }],
            '2025-09-26': [{ id: '2025-09-26-1', time: '18:00 ‚Äì 21:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ—á–Ω–æ' }],
            '2025-09-27': [
                { id: '2025-09-27-1', time: '10:00 ‚Äì 13:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ—á–Ω–æ' },
                { id: '2025-09-27-2', time: '14:15 ‚Äì 17:30', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ–Ω–ª–∞–π–Ω' }
            ],
            '2025-10-01': [{ id: '2025-10-01-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ—á–Ω–æ' }],
            '2025-10-02': [{ id: '2025-10-02-1', time: '18:00 ‚Äì 19:30', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ–Ω–ª–∞–π–Ω' }],
            '2025-10-04': [
                { id: '2025-10-04-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ—á–Ω–æ' },
                { id: '2025-10-04-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-10-08': [{ id: '2025-10-08-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ—á–Ω–æ' }],
            '2025-10-09': [{ id: '2025-10-09-1', time: '18:00 ‚Äì 20:30', name: 'Research Seminar III', teacher: '–°–º–∏—Ä–Ω–æ–≤ –ú.–í.', format: '–æ—á–Ω–æ' }],
            '2025-10-10': [{ id: '2025-10-10-1', time: '18:00 ‚Äì 21:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ—á–Ω–æ' }],
            '2025-10-11': [
                { id: '2025-10-11-1', time: '10:00 ‚Äì 13:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ—á–Ω–æ' },
                { id: '2025-10-11-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-10-13': [{ id: '2025-10-13-1', time: '17:15 ‚Äì 22:00', name: 'Sustainable Finance', teacher: '–ê–Ω–¥—Ä–∏–∞–Ω–æ–≤ –ê.–Æ.', format: '–æ—á–Ω–æ' }],
            '2025-10-18': [
                { id: '2025-10-18-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ—á–Ω–æ' },
                { id: '2025-10-18-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-10-24': [{ id: '2025-10-24-1', time: '18:00 ‚Äì 21:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ–Ω–ª–∞–π–Ω' }],
            '2025-10-25': [
                { id: '2025-10-25-1', time: '10:00 ‚Äì 13:15', name: 'Banking & Fintech Industry', teacher: '–î–æ—Ä–æ–∂–∫–∏–Ω –ü.–õ.', format: '–æ–Ω–ª–∞–π–Ω' },
                { id: '2025-10-25-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-10-27': [{ id: '2025-10-27-1', time: '17:15 ‚Äì 22:00', name: 'Sustainable Finance', teacher: '–ê–Ω–¥—Ä–∏–∞–Ω–æ–≤ –ê.–Æ.', format: '–æ—á–Ω–æ' }],
            '2025-10-31': [{ id: '2025-10-31-1', time: '18:00 ‚Äì 20:30', name: 'Research Seminar III', teacher: '–°–º–∏—Ä–Ω–æ–≤ –ú.–í.', format: '–æ—á–Ω–æ' }],
            '2025-11-01': [
                { id: '2025-11-01-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ–Ω–ª–∞–π–Ω' },
                { id: '2025-11-01-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-11-07': [{ id: '2025-11-07-1', time: '18:00 ‚Äì 21:15', name: 'Research Seminar III', teacher: '–°–º–∏—Ä–Ω–æ–≤ –ú.–í.', format: '–æ—á–Ω–æ' }],
            '2025-11-08': [
                { id: '2025-11-08-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ–Ω–ª–∞–π–Ω' },
                { id: '2025-11-08-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-11-15': [{ id: '2025-11-15-1', time: '10:00 ‚Äì 17:30', name: 'Effective Team Management', teacher: '–ó–µ–º—Å–∫–æ–≤ –û.–û.', format: '–æ—á–Ω–æ' }],
            '2025-11-17': [{ id: '2025-11-17-1', time: '17:15 ‚Äì 22:00', name: 'Sustainable Finance', teacher: '–ê–Ω–¥—Ä–∏–∞–Ω–æ–≤ –ê.–Æ.', format: '–æ—á–Ω–æ' }],
            '2025-11-22': [
                { id: '2025-11-22-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ—á–Ω–æ' },
                { id: '2025-11-22-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-11-25': [{ id: '2025-11-25-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ–Ω–ª–∞–π–Ω' }],
            '2025-11-28': [{ id: '2025-11-28-1', time: '18:00 ‚Äì 20:30', name: 'Research Seminar III', teacher: '–°–º–∏—Ä–Ω–æ–≤ –ú.–í.', format: '–æ—á–Ω–æ' }],
            '2025-11-29': [{ id: '2025-11-29-1', time: '10:00 ‚Äì 17:30', name: 'Effective Team Management', teacher: '–ó–µ–º—Å–∫–æ–≤ –û.–û.', format: '–æ—á–Ω–æ' }],
            '2025-12-01': [{ id: '2025-12-01-1', time: '17:15 ‚Äì 22:00', name: 'Sustainable Finance', teacher: '–ê–Ω–¥—Ä–∏–∞–Ω–æ–≤ –ê.–Æ.', format: '–æ—á–Ω–æ' }],
            '2025-12-02': [{ id: '2025-12-02-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ–Ω–ª–∞–π–Ω' }],
            '2025-12-06': [{ id: '2025-12-06-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ—á–Ω–æ' }],
            '2025-12-09': [{ id: '2025-12-09-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ–Ω–ª–∞–π–Ω' }],
            '2025-12-13': [
                { id: '2025-12-13-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ—á–Ω–æ' },
                { id: '2025-12-13-2', time: '14:15 ‚Äì 17:30', name: 'Alternative Investments and Portfolio Management', teacher: '–í–ª–∞—Å–æ–≤ –ü.–ê., –ì–æ–Ω—á–∞—Ä–æ–≤–∞ –ì.–°.', format: '–æ—á–Ω–æ' }
            ],
            '2025-12-15': [{ id: '2025-12-15-1', time: '10:00 ‚Äì 15:45', name: 'Sustainable Finance', teacher: '–ê–Ω–¥—Ä–∏–∞–Ω–æ–≤ –ê.–Æ.', format: '–æ—á–Ω–æ' }],
            '2025-12-16': [{ id: '2025-12-16-1', time: '18:00 ‚Äì 21:15', name: 'Risks and Risk Management', teacher: '–ë—É–∫–æ–≤–∏—á –î., –õ–æ—Å–µ–≤ –ö.–í.', format: '–æ–Ω–ª–∞–π–Ω' }],
            '2025-12-18': [{ id: '2025-12-18-1', time: '18:00 ‚Äì 22:00', name: 'Research Seminar III', teacher: '–°–º–∏—Ä–Ω–æ–≤ –ú.–í.', format: '–æ—á–Ω–æ' }],
            '2025-12-20': [{ id: '2025-12-20-1', time: '10:00 ‚Äì 13:15', name: 'Fixed income and Derivatives', teacher: '–ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ –ê.–ê.', format: '–æ—á–Ω–æ' }]
        };
        const ELECTIVE_NAMES = [
            'Advanced Performance Management',
            'Corporate Law in Russia',
            'Banking & Fintech Industry',
            'Alternative Investments and Portfolio Management'
        ];

        // --- –ö–õ–ê–°–°–´ –ò –ú–û–î–£–õ–ò ---
        class NotesManager {
            constructor(userId) {
                this.userId = userId;
                this.prefix = `note:${this.userId}:`;
                this.notes = {};
                this.ready = this.init();
            }
            async init() {
                if (!cs) return;
                try {
                    const keys = await cs.getKeys();
                    const myKeys = keys.filter(k => k.startsWith(this.prefix));
                    const entries = await Promise.all(
                        myKeys.map(async k => [k.slice(this.prefix.length), await cs.getItem(k)])
                    );
                    this.notes = Object.fromEntries(entries.filter(([, v]) => v && v.length));
                    this.updateNotesDisplay();
                } catch (e) { console.error('Failed to init notes:', e); }
            }
            async setNote(classId, text) {
                if (!cs) return;
                const value = (text || '').trim();
                const key = this.prefix + classId;
                try {
                    if (value) {
                        this.notes[classId] = value;
                        await cs.setItem(key, value);
                    } else {
                        delete this.notes[classId];
                        await cs.removeItem(key);
                    }
                    this.updateNotesDisplay();
                } catch (e) { console.error('Failed to save note:', e); }
            }
            getNote(classId) { return this.notes[classId] || ''; }
            updateNotesDisplay() {
                document.getElementById('notesCount').textContent = Object.keys(this.notes).length;
                document.querySelectorAll('.day.has-note').forEach(day => day.classList.remove('has-note'));
                Object.keys(this.notes).forEach(classId => {
                    const date = classId.split('-').slice(0, 3).join('-');
                    const dayElement = document.querySelector(`.day[data-date="${date}"]`);
                    if (dayElement) dayElement.classList.add('has-note');
                });
            }
        }

        // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function initializeApp() {
            if (tg && tg.initDataUnsafe?.user) {
                tg.ready();
                tg.expand();
                const cloud = tg.CloudStorage;
                if (!cloud) {
                     document.body.innerHTML = '<div style="padding:24px;font:16px/1.4 system-ui">–û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ CloudStorage.</div>';
                     return;
                }
                cs = {
                    getKeys: () => new Promise((res, rej) => cloud.getKeys((e, k) => e ? rej(e) : res(k || []))),
                    getItem: (key) => new Promise((res, rej) => cloud.getItem(key, (e, v) => e ? rej(e) : res(v ?? ''))),
                    setItem: (key, val) => new Promise((res, rej) => cloud.setItem(key, val, (e) => e ? rej(e) : res())),
                    removeItem: (key) => new Promise((res, rej) => cloud.removeItem(key, (e) => e ? rej(e) : res())),
                };
                currentUser = tg.initDataUnsafe.user;
                displayUserInfo(currentUser);
            } else {
                const store = window.localStorage;
                cs = {
                    getKeys: async () => Object.keys(store),
                    getItem: async (key) => store.getItem(key) ?? '',
                    setItem: async (key, val) => { store.setItem(key, val); },
                    removeItem: async (key) => { store.removeItem(key); },
                };
                currentUser = { id: 'local_user', first_name: 'Local', last_name: 'User' };
                displayUserInfo(currentUser);
            }
            notesManager = new NotesManager(currentUser.id);
        }

        function displayUserInfo(user) {
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userAvatar').textContent = user.first_name[0].toUpperCase();
            document.getElementById('userName').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            document.getElementById('userUsername').textContent = user.username ? '@' + user.username : 'ID: ' + user.id;
        }

        function isElective(name) { return ELECTIVE_NAMES.includes(name); }
        function buildElectivesUI() {
            const wrap = document.getElementById('electivesList');
            if (!wrap) return;
            wrap.innerHTML = ELECTIVE_NAMES.map(n => {
                const id = 'elc-' + n.replace(/[^a-z0-9]+/gi, '-').toLowerCase();
                const checked = selectedElectives.has(n) ? 'checked' : '';
                return `<label style="display:flex;gap:8px;align-items:center;padding:4px;cursor:pointer;"><input type="checkbox" id="${id}" value="${n}" ${checked} /><span>${n}</span></label>`;
            }).join('');
        }
        async function loadElectives() {
            if (!cs || !currentUser) return;
            try {
                const raw = await cs.getItem(`electives:${currentUser.id}`);
                if (raw) {
                    selectedElectives = new Set(JSON.parse(raw));
                } else {
                    selectedElectives = new Set();
                    setTimeout(showElectivesModal, 100);
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–ª–µ–∫—Ç–∏–≤—ã:', e);
                selectedElectives = new Set();
                setTimeout(showElectivesModal, 100);
            }
        }
        function showElectivesModal() {
            buildElectivesUI();
            document.getElementById('electivesModal').style.display = 'block';
        }
        function hideElectivesModal() {
            document.getElementById('electivesModal').style.display = 'none';
        }
        function readElectivesFromUI() {
            const next = new Set();
            ELECTIVE_NAMES.forEach(n => {
                const id = 'elc-' + n.replace(/[^a-z0-9]+/gi, '-').toLowerCase();
                const el = document.getElementById(id);
                if (el?.checked) next.add(n);
            });
            selectedElectives = next;
        }
        async function saveElectivesToCloud() {
            if (!cs || !currentUser) return;
            const arr = Array.from(selectedElectives);
            await cs.setItem(`electives:${currentUser.id}`, JSON.stringify(arr));
        }
        function filterByElectives(classes) {
            return classes.filter(c => !isElective(c.name) || selectedElectives.has(c.name));
        }
        function editNote(classId) {
            document.getElementById(`note-display-${classId}`).style.display = 'none';
            document.getElementById(`note-edit-${classId}`).style.display = 'block';
            document.getElementById(`note-text-${classId}`).focus();
        }
        function saveNote(classId) {
            const textarea = document.getElementById(`note-text-${classId}`);
            const text = textarea.value.trim();
            notesManager.setNote(classId, text);
            const displayDiv = document.getElementById(`note-display-${classId}`);
            displayDiv.textContent = text;
            displayDiv.style.display = text ? 'block' : 'none';
            document.getElementById(`note-edit-${classId}`).style.display = 'none';
            const btn = document.querySelector(`button[onclick="editNote('${classId}')"]`);
            if (btn) btn.textContent = text ? '–ò–∑–º–µ–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å';
            if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }
        function cancelEditNote(classId) {
            const textarea = document.getElementById(`note-text-${classId}`);
            const originalNote = notesManager.getNote(classId);
            textarea.value = originalNote;
            document.getElementById(`char-count-${classId}`).textContent = originalNote.length;
            document.getElementById(`note-edit-${classId}`).style.display = 'none';
            document.getElementById(`note-display-${classId}`).style.display = originalNote ? 'block' : 'none';
        }
        async function confirmPopup(message) {
            if (tg?.showPopup) {
                return new Promise(resolve => {
                    tg.showPopup({
                        message,
                        buttons: [{id: 'yes', type: 'destructive', text: '–î–∞, —Å–±—Ä–æ—Å–∏—Ç—å'}, {type: 'cancel'}]
                    }, (id) => resolve(id === 'yes'));
                });
            }
            return Promise.resolve(confirm(message));
        }
        async function resetProfile() {
            const ok = await confirmPopup('–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–∫—Ç–∏–≤—ã –∏ –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');
            if (!ok || !cs || !currentUser) return;
            try {
                const userId = currentUser.id;
                const keys = await cs.getKeys();
                const toDelete = keys.filter(k => k.startsWith(`note:${userId}:`) || k === `electives:${userId}`);
                for (const k of toDelete) { await cs.removeItem(k); }
                selectedElectives.clear();
                notesManager.notes = {};
                notesManager.updateNotesDisplay();
                updateCalendarAppearance();
                if (tg?.showPopup) tg.showPopup({ message: '–ü—Ä–æ—Ñ–∏–ª—å —Å–±—Ä–æ—à–µ–Ω.' });
                else alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–±—Ä–æ—à–µ–Ω.');
                showElectivesModal();
            } catch (e) {
                const errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ—Ñ–∏–ª—è: ' + (e?.message || e);
                if (tg?.showPopup) tg.showPopup({ message: errorMessage });
                else alert(errorMessage);
            }
        }
        
        function updateCalendarAppearance() {
            document.querySelectorAll('.day[data-date]').forEach(dayElement => {
                const date = dayElement.getAttribute('data-date');
                const initialClasses = classData[date] || [];
                const remainingClasses = filterByElectives(initialClasses);
                
                dayElement.classList.remove('busy', 'free', 'online-only');
                
                if (remainingClasses.length > 0) {
                    const allOnline = remainingClasses.every(cls => cls.format === '–æ–Ω–ª–∞–π–Ω');
                    dayElement.classList.add(allOnline ? 'online-only' : 'busy');
                } else {
                    dayElement.classList.add('free');
                }
            });
            updateSummaryStatistics();
        }

        function updateSummaryStatistics() {
            const classDaysCount = document.querySelectorAll('.day.busy, .day.online-only').length;
            const freeDaysCount = document.querySelectorAll('.calendar-grid .day.free').length;
            document.getElementById('classDaysCount').textContent = classDaysCount;
            document.getElementById('freeDaysCount').textContent = freeDaysCount;
        }

        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò –ó–ê–ü–£–°–ö ---
        async function main() {
            initializeApp();
            await loadElectives();
            setupEventListeners();
            updateCalendarAppearance();
        }

        function setupEventListeners() {
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ —Å—Ç–∞—Ç–∏—á–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
            document.getElementById('configureElectives').addEventListener('click', showElectivesModal);
            document.getElementById('resetProfile').addEventListener('click', resetProfile);

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            const classModal = document.getElementById('classModal');
            classModal.addEventListener('click', (event) => {
                if (event.target.classList.contains('close')) {
                    classModal.style.display = 'none';
                }
            });
            
            const electivesModal = document.getElementById('electivesModal');
            electivesModal.addEventListener('click', async (event) => {
                const target = event.target;
                if (target.id === 'saveElectives') {
                    readElectivesFromUI();
                    await saveElectivesToCloud();
                    hideElectivesModal();
                    updateCalendarAppearance(); // –û–±–Ω–æ–≤–ª—è–µ–º UI
                } else if (target.id === 'cancelElectives' || target.id === 'closeElectives') {
                    hideElectivesModal();
                }
            });

            window.addEventListener('click', (event) => {
                if (event.target === classModal) classModal.style.display = 'none';
                if (event.target === electivesModal) hideElectivesModal();
            });

            document.querySelectorAll('.day.busy[data-date], .day.online-only[data-date]').forEach(day => {
                day.addEventListener('click', async function() {
                    const date = this.getAttribute('data-date');
                    let classes = classData[date] || [];
                    if (notesManager?.ready) await notesManager.ready;
                    
                    classes = filterByElectives(classes);
                    
                    document.getElementById('modalTitle').textContent = `–ó–∞–Ω—è—Ç–∏—è ${new Date(date).toLocaleDateString('ru-RU', {day: 'numeric', month: 'long', year: 'numeric'})}`;
                    const modalBody = document.getElementById('modalBody');
                    
                    if (classes.length > 0) {
                        modalBody.innerHTML = classes.map(cls => {
                            const note = notesManager.getNote(cls.id);
                            const disabledAttr = !notesManager ? 'disabled style="pointer-events:none;opacity:.5;"' : '';
                            return `
                            <div class="class-item">
                                <div class="class-time">${cls.time}</div>
                                <div class="class-name">${cls.name}</div>
                                <div class="class-teacher">${cls.teacher}</div>
                                <span class="class-format ${cls.format === '–æ–Ω–ª–∞–π–Ω' ? 'format-online' : 'format-offline'}">${cls.format}</span>
                                <div class="note-section">
                                    <div class="note-header">
                                        <span class="note-label">–ó–∞–º–µ—Ç–∫–∞:</span>
                                        <button class="note-btn" ${disabledAttr} onclick="editNote('${cls.id}')">${note ? '–ò–∑–º–µ–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}</button>
                                    </div>
                                    <div id="note-display-${cls.id}" class="note-display" style="display: ${note ? 'block' : 'none'}">${note}</div>
                                    <div id="note-edit-${cls.id}" style="display: none;">
                                        <textarea class="note-text" id="note-text-${cls.id}" maxlength="512" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫—É...">${note}</textarea>
                                        <div class="note-char-count"><span id="char-count-${cls.id}">${note.length}</span>/512</div>
                                        <div class="note-actions">
                                            <button class="btn" onclick="saveNote('${cls.id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                            <button class="btn btn-secondary" onclick="cancelEditNote('${cls.id}')">–û—Ç–º–µ–Ω–∞</button>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('');
                    } else {
                        modalBody.innerHTML = `<div style="padding:16px;">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å —É –≤–∞—Å –Ω–µ—Ç –∑–∞–Ω—è—Ç–∏–π.<br/><br/><button class="btn" onclick="showElectivesModal()">–í—ã–±—Ä–∞—Ç—å —ç–ª–µ–∫—Ç–∏–≤—ã</button></div>`;
                    }
                    
                    classModal.style.display = 'block';
                    
                    classes.forEach(cls => {
                        const textarea = document.getElementById(`note-text-${cls.id}`);
                        if(textarea) {
                            textarea.addEventListener('input', () => {
                                document.getElementById(`char-count-${cls.id}`).textContent = textarea.value.length;
                            });
                        }
                    });
                });
            });
        }
        
        // --- –ü–†–ò–í–Ø–ó–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–´–• –§–£–ù–ö–¶–ò–ô –ö WINDOW ---
        window.editNote = editNote;
        window.saveNote = saveNote;
        window.cancelEditNote = cancelEditNote;
        window.showElectivesModal = showElectivesModal;
        
        // --- –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
